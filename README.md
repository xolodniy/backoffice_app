# Backoffice App

## **Application flow**

1. Sending daily workers reports by CRON. Can be sent manually by command line switch using.
2. Sending weekly workers reports by CRON Can be sent manually by command line switch using.
3. Gets jira exceedions right now and sending it to some Slack channel that specified config


## **Command Line Switches**
*Get Jira exceedions and send them to Slack channel, immediately:*

    $ ./backoffice-app get-jira-exceedions-now

*Send weekly report to Slack channel, immediately:*

    $ ./backoffice-app make-weekly-report-now

*Sends daily report to Slack channel, immediately:*

    $ ./backoffice-app make-daily-report-now
    
*Sends current employees exceeded time report to Slack channel, immediately:*

    $ ./backoffice-app report-exceeded-estimate-now

*Obtains Hubstaff authorization token:*

    $ ./backoffice-app obtain-hubstaff-token

*Send last activity report to slack right now*

    $ ./backoffice-app send-last-activity-report-now

## **Directory Structure**
    app/          — Go application domain layer
    controller/   — Go router layer
    config/       — Go confg folder
    vendor/       — Go 3rd-party libraries

    main.go       — Main project file
    go.mod        — `go mod` auto-generated file with project dependencies. Defines a tree of Go source files.
    go.sum        — Defines a collection of checksums of each libraries for other programmers to check whether those libraries are hacked or not.
    

## **Running the Application**

### **Prerequisites**
You have to use *Go 1.11*, then it will load all dependencies needed to building by him self, but only if `go.mod` and `go.sum` stay's in project's root folder


### **How to BUILD**

Now you can clone the application and prepare it for running:

1. Clone repository

        $ git clone git@bitbucket.org:theflowglobal/backoffice_app.git
    
1. Go to app directory

        $ cd ./backoffice_app
    
1. Build application with:
 
        $ go build -o backoffice-app ./main.go

1. Make application runnable in term

        $ chmod +x ./backoffice-app
    
1. Run the app

        $ ./backoffice-app
        
        
### Where can I get credentials

#### GIT
* ##### gittoken
  1. can be obtain only if you maintainer of the project as minimum (https://docs.gitlab.com/ce/user/permissions.html)
  2. go to https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#creating-a-personal-access-token instruction to generate token 


#### Jira
* ##### apiurl
  API URL is always is on https://{orgname}.atlassian.net
  For "The flow" it will be https://theflow.atlassian.net
* ##### username and password
  It's org maintainer or special account requisites that can view projects (but can't change them (more secured way))


#### Slack:
* ##### apiurl 
  API URL can be taken here: https://api.slack.com/web#basics

* ##### intoken
  Token used to check requests from Slack to this application.
  Token can be generated here https://api.slack.com/docs/verifying-requests-from-slack

* ##### outtoken
  `outtoken` is API token. It will be used to make requests to Slack API.
Can be gathered from https://api.slack.com/custom-integrations/legacy-tokens#legacy_token_generator

* ##### migrationsid
  Slack channel id without hash in it

* ##### backofficeappid
  This App User ID of messages source in Slack

* ##### botname
  This App User Name of messages source in Slack

#### Hubstaff
* ##### apiurl
  Can be taken from https://support.hubstaff.com/time-tracking-api/
  By default it's: https://api.hubstaff.com

* ##### token
  It's an OAuth token generated by Hubstaff within you Login and Password config fields.
  Must be obtained by using of APP CLI obtain-hubstaff-token parameter, after you've Login and Password config fields filled
 
* ##### apptoken 
  It's related to an Organisation, Hubstaff App Token which can be generated here:
  https://developer.hubstaff.com/my_apps

* ##### orgsid
  It's numeric ID of some concrete organisation of Hubstaff account
  Must be obtained through using of Hubstaff API Tester interface here: https://developer.hubstaff.com/docs/api#!/organizations/getV1Organizations

* ##### username and password
  It's org maintainer or special account requisites that can view time records (but can't change them (more secured way))
     
### Start API with the custom config

1. Change example `./config/config.yml` 
2. Start project

### Config file
#### Slack

    totalVolume: 5.0    -variable of availible total space on slack.
    restVolume: 0.0     -variable of rest space, when we want send report.
    intoken: 123456     -the user token for slack's user api
    outtoken: 123456    -the bot token for slack's bot api
 
#### Cron manager reports parameters 

1. schedule: "00 00 07 * * *"    — cron prefence for adding tasks
2. channel: "#back-office-app"   - slack channel, user id or user real name for sending reports by cron 

#### Cron manager settings 
   
    Field name   | Mandatory? | Allowed values  | Allowed special characters
    ----------   | ---------- | --------------  | --------------------------
    Seconds      | Yes        | 0-59            | * / , -
    Minutes      | Yes        | 0-59            | * / , -
    Hours        | Yes        | 0-23            | * / , -
    Day of month | Yes        | 1-31            | * / , - ?
    Month        | Yes        | 1-12 or JAN-DEC | * / , -
    Day of week  | Yes        | 0-6 or SUN-SAT  | * / , - ?
    
You may use one of several pre-defined schedules in place of a cron expression.

    Entry                  | Description                                | Equivalent To
    -----                  | -----------                                | -------------
    @yearly (or @annually) | Run once a year, midnight, Jan. 1st        | 0 0 0 1 1 *
    @monthly               | Run once a month, midnight, first of month | 0 0 0 1 * *
    @weekly                | Run once a week, midnight between Sat/Sun  | 0 0 0 * * 0
    @daily (or @midnight)  | Run once a day, midnight                   | 0 0 0 * * *
    @hourly                | Run once an hour, beginning of hour        | 0 0 * * * *

#### Config.yml variables for reports 

      dailyworkersworkedtime:           — preference to send daily worked time of worker
        schedule: "00 00 07 * * *"  
        channel: "#back-office-app"
      weeklyworkersworkedtime:          — preference to send weekly worked time of worker
        schedule: "00 00 07 * * 1" 
        channel: "#back-office-app"
      reportclosedsubtasks:             — preference to send report about all closed subtask of issue
        schedule: "00 00 07 * * *" 
        channel: "#back-office-app"   
      reportaftersecondreviewall:       — preference to send report about issues after second round review
        schedule: "00 00 06 * * *"
        channel: "U891K2Z2P"
      reportaftersecondreviewbe:        — preference to send report about backend issues after second round review
        schedule: "00 00 06 * * *"
        channel: "U97DJLL11"
      reportaftersecondreviewfe:        — preference to send report about frontend issues after second round review
        schedule: "00 00 06 * * *"
        channel: "U88K5BQAD"
      employeesexceededtasks:           — preference to send report about employers that have exceeded tasks
        schedule: "00 00 07 * * *" 
        channel: "#back-office-app"
      reportslackspaceending:           — start everyday at 7:00 to send report if free space on slack < 0.5GB
        schedule: "00 00 07 * * *"
        channel: "#back-office-app"
      reportgitmigrations:              — preference to send report about new git migrations
        schedule: "@hourly"
        channel: "#migrations"
      reportsprintstatus:               - preference to send report about open sprint status
        schedule: "00 00 05 * * MON"
        channel: "#general"
      reportclarificationissues:        - preference to send report about clarification issues to users, that assigned, and it hasn't channel
        schedule: "00 00 07 * * *"
      report24hoursreviewissues:        - preference to send report about long time review of issues to users, that assigned, and it hasn't channel
        schedule: "00 00 07 * * *"
      reportgitansiblechanges:          — preference to send report about new git ansible changes
        schedule: "@hourly"
        channel: "U8A004WK0"
      dailyworkerslessworkedmessage:    — preference to send report about workers worked less then 6 hours
        schedule: "00 00 06 * * *"
        channel: "#general"
      weeklyreportoverworkedissues:     — preference to send report about issues with overworked time if remaining time == 0
        schedule: "00 00 07 * * 1"
        channel: "#back-office-app"
      reportepicclosedissues:           — preference to send report about all closed issues of epic
        schedule: "00 00 07 * * *"
        channel: "#back-office-app"
      checkneedreplymessages:           — preference to send mention if user must reply on old mention
        schedule: "@yearly"
    
#### Config.yml variables for slack users id

      employees:                        - this is employees variables of users ids to mention them in messages, or send mmessages to them.
        directorofcompany: U891K2Z2P    - this is variable of director of company
        projectmanager: U9FDU5W4D       - this is variable of project manager
        artdirector: U89802W2Z          - this is variable of art director
        teamleaderbe: U97DJLL11         - this this is variable of team leader of backend
        teamleaderfe: U88K5BQAD         - this is variable of team leader of frontend
        
        beteam:                         - slice of backend team 
          - 'Stepan Morozov'
          - 'Arthur Danilevsky'
          - 'Roman Vlasenko'
          - 'Muzafar Muradov'
        feteam:                         - slice of frontend team 
          - 'Andrey Solovyov'
          - 'Elena Parkacheva'
          
          
#### Config.yml variables for Amplify 

    amplify:
      notifychannelid: CKBT66G5A    - channel, where Amplify sends all notifies
      channelstag: '#cdto-staging'  - channel, where we must resend message of staging
      channelprod: '#cdto'          - channel, where we must resend message of production
      mention:                      - people, that we mention if message about production
        - U97DJLL11
        - U891K2Z2P
        - UG47GFL92
     
#### Config.yml variables for Jira 
    
    jira:
      apiurl: https://theflow.atlassian.net  - url of jira cloud
      auth:
        username: {{ jira_login }}           - user login
        token: {{ jira_token }}        - user token for app https://id.atlassian.com/manage/api-tokens?_ga=2.197139692.2116077052.1563351418-1201316844.1557426941

User id you can find in slack: 
1. Click on the users name and choose "Show Profile".
2. Open the "..." menu.
3. Click button "Copy Member-ID ..."

#### Config.yml variables for user info 

    users:                                       - users information of services
      - jiraaccountid: 5a2575776a747c0e71ab2972  - jira account id
        email: andrey.solovyov@theflow.global    - user email
        slackid: U8990009Z                       - user slack id
        slackname: tinymail8                     - user slack nick name
        slackrealname: "Andrey Solovyov"         - user slack real name

### API Description

Please see [Postman API documentation](https://lively-water-8721.postman.co/collections/4828556-aa316412-299a-4ab1-8608-670e4ac7e591)

## Support

In case of any bugs , please, contact support@theflow.global


## Deployment with ANSIBLE

### Prerequisites

For deploying this project Ansible is required. Ansible docs can be founded here: https://docs.ansible.com/

Currently, we have an one playbook:

 - application.yml

`application.yml` preserves common environment and deploy selected version of application.

If you want to deploy application from a custom branch (default branch is 'master') -
go to playbooks/application.yml and change 'version' variable to what you need

### How to deploy a project to your's local machine into docker container

You can use docker image for testing a deploy project and ensure that all works correct.
Prepare related software, ansible and docker must be installed.

Just follow next steps:
 - update permissions for correct using rsa key by `sudo chmod 0600` for ./id_rsa & ./id_rsa.pub
 - create docker container by command `make build`
 - start running scripts by command `ansible-playbook --key-file id_rsa -i inventories/dev/hosts.yml playbooks/application.yml`
 - do `make ssh` to deep inside container and check that application is running

After deploy backEnd binary will be in /usr/local/bin folder, if you want to run it with some cli commands -
use `/usr/local/bin/{{ project_name }} {{  cli_command }}`

### How to deploy a project to a staging server

Prepare your's ssh config file, specify host, port and user name for server which will be used for deploy.

Example of specified ssh config:
```
cat ~/.ssh/config

Host demo.theflow.global
    HostName 123.123.123.123
    User root
    IdentityFile ~/.ssh/id_rsa

```

 - Write previously specified server name in the ./inventories/staging/hosts.yml
 - Start scripts by `ansible-playbook -i inventories/staging/host.yml playbooks/main.yml`
 - Go to your host in browser
 
After deploy backEnd binary will be in /usr/local/bin folder, if you want to run it with some cli commands -
use `/usr/local/bin/{{ project_name }} {{  cli_command }}`

### How to

#### Check your service status
  >systemctl status backoffice_app_api

#### Restart a service
  >systemctl restart backoffice_app_api

#### See service logs
  >journalctl --since 10:00 -u backoffice_app_api

examples of 'since' parameter:
 - yesterday
 - today
 - 2018-10-20
 - "2018-10-20 12:48"
 note that you and server most likely in different timezones
