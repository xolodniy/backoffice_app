# Backoffice App

## Application destination

1. Sending daily workers reports by CRON. Can be sent manually by command line switch using.
2. Sending weekly workers reports by CRON Can be sent manually by command line switch using.
3. Gets jira exceedions right now and sending it to some Slack channel that specified config


## Command Line Switches

1. get-jira-exceedions-now - Gets jira exceedions right now
2. make-weekly-report-now - Sends weekly report to slack channel
3. make-daily-report-now - Sends daily report to slack channel
4. obtain-hubstaff-token - Obtains Hubstaff authorization token


## Directory Structure

    app/          - Go application domain layer
    controller/   - Go router layer
    config/       - Go confg folder
    vendor/       - Go 3rd-party libraries

    main.go              - Main project file
    Gopkg.toml           - Auto-generated file with project dependencies
    Gopkg.lock           - Hash-sum of project dependencies


## Running the Application

### Prerequisites

Now you can clone the application and prepare it for running:

    Clone repository
    $ git clone git@bitbucket.org:theflowglobal/backoffice_app.git
    
    Go to app directory
    $ cd ./backoffice_app
    
    Use dep to load dependencies (if there is no dependencies in /vendor folder)
    $ dep init
    or if you already have some dependencies downloaded
    $ dep ensure
    
    Build application with:
    $ go build -o backoffice-app ./main.go
    
    Make application runnable in terminal
    chmod +x ./backoffice-app
    
    Run the app
    ./backoffice-app

### Where can I get creditionals
#### gittoken
 1. can be obtain only if you maintainer of the project as minimum (https://docs.gitlab.com/ce/user/permissions.html)
 2. go to https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#creating-a-personal-access-token instruction to generate token 


#### Jira
##### apiurl
API URL is always is on https://{orgname}.atlassian.net
For "The flow" it will be https://theflow.atlassian.net
##### username and password
It's org maintainer or special account requisites that can view projects (but can't change them (more secured way))


#### Slack:
##### apiurl 
API URL can be taken here: https://api.slack.com/web#basics

##### intoken
Token used to check requests from Slack to this application.
Token can be generated here https://api.slack.com/docs/verifying-requests-from-slack

##### outtoken
outtoken is API token. It will be used to make requests to Slack API.
Can be gathered from https://api.slack.com/custom-integrations/legacy-tokens#legacy_token_generator

##### migrationsid
Slack channel id without hash in it

##### backofficeappid
This App User ID of messages source in Slack

##### botname
This App User Name of messages source in Slack

#### Hubstaff
##### apiurl
Can be taken from https://support.hubstaff.com/time-tracking-api/
By default it's:  https://api.hubstaff.com

##### token
It's an OAuth token generated by Hubstaff within you Login and Password config fields.
Must be obtained by using of APP CLI obtain-hubstaff-token parameter, after you've Login and Password config fields filled
 
##### apptoken 
It's related to an Organisation, Hubstaff App Token which can be generated here:
https://developer.hubstaff.com/my_apps

##### orgsid
It's numeric ID of some concrete organisation of Hubstaff account
Must be obtained through using of Hubstaff API Tester interface here: https://developer.hubstaff.com/docs/api#!/organizations/getV1Organizations

##### username and password
It's org maintainer or special account requisites that can view time records (but can't change them (more secured way))
     
### Start API with the custom config

1. Change example `./config/config.yml` 
2. Start project

### API Description

Please see [Postman API documentation](https://lively-water-8721.postman.co/collections/4828556-aa316412-299a-4ab1-8608-670e4ac7e591)

## Support

In case of any bugs , please, contact support@theflow.global

## Deployment

### Prerequisites

For deploying this project Ansible is required. Ansible docs can be founded here: https://docs.ansible.com/

Currently, we have an one playbook:

 - application.yml

`application.yml` preserves common environment and deploy selected version of application.

If you want to deploy application from a custom branch (default branch is 'master') -
go to playbooks/application.yml and change 'version' variable to what you need

### How to deploy a project to your's local machine into docker container

You can use docker image for testing a deploy project and ensure that all works correct.
Prepare related software, ansible and docker must be installed.

Just follow next steps:
 - update permissions for correct using rsa key by `sudo chmod 0600` for ./id_rsa & ./id_rsa.pub
 - create docker container by command `make build`
 - start running scripts by command `ansible-playbook --key-file id_rsa -i inventories/dev/hosts.yml playbooks/application.yml`
 - do `make ssh` to deep inside container and check that application is running

After deploy backEnd binary will be in /usr/local/bin folder, if you want to run it with some cli commands -
use `/usr/local/bin/{{ project_name }} {{  cli_command }}`

### How to deploy a project to a staging server

Prepare your's ssh config file, specify host, port and user name for server which will be used for deploy.

Example of specified ssh config:
```
cat ~/.ssh/config

Host demo.theflow.global
    HostName 123.123.123.123
    User root
    IdentityFile ~/.ssh/id_rsa

```

 - Write previously specified server name in the ./inventories/staging/hosts.yml
 - Start scripts by `ansible-playbook -i inventories/staging/host.yml playbooks/main.yml`
 - Go to your host in browser
 
After deploy backEnd binary will be in /usr/local/bin folder, if you want to run it with some cli commands -
use `/usr/local/bin/{{ project_name }} {{  cli_command }}`

### How to

#### Check your service status
  >systemctl status backoffice_app_api

#### Restart a service
  >systemctl restart backoffice_app_api

#### See service logs
  >journalctl --since 10:00 -u backoffice_app_api

examples of 'since' parameter:
 - yesterday
 - today
 - 2018-10-20
 - "2018-10-20 12:48"
 note that you and server most likely in different timezones
